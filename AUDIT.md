# Audit Releaf App

## Critiques
- **Fonctionnalité – Lecture audio SoundTherapy** : `SoundTherapyEngine.startFrequency` lance `generateAudio` via `launch` à l'intérieur d'un `withContext`, ce qui bloque toute reprise tant que le job audio reste actif (`app/src/main/java/com/releaf/app/audio/SoundTherapyEngine.kt:29`). Les appels du `SoundTherapyViewModel` ne peuvent pas mettre à jour l'état (le flux reste suspendu), rendant l'écran inopérant. *Préconisation* : déplacer la génération sonore dans un scope dédié (ex. `CoroutineScope(SupervisorJob() + Dispatchers.IO)`) ou retourner immédiatement après avoir démarré l'audio, puis piloter l'arrêt via le job stocké.

## Majeures
- **Fonctionnalité – Streak utilisateur erroné** : `calculateCurrentStreak` incrémente simplement pour chaque session sans vérifier la continuité des dates (`app/src/main/java/com/releaf/app/data/repository/UserRepository.kt:139`). Les statistiques et objectifs basés sur les séries sont donc incorrects. *Préconisation* : comparer explicitement les dates consécutives (via `LocalDate`) et réinitialiser la série lorsqu'un jour est manquant.
- **Localisation – Changement de langue non appliqué** : `LanguagePreferences.applyLanguage` crée un nouveau contexte mais n’applique pas la configuration retournée ni n’actualise les ressources (`app/src/main/java/com/releaf/app/data/LanguagePreferences.kt:32`). Résultat : les préférences de langue n’ont pas d’effet réel. *Préconisation* : utiliser `context.applicationContext.resources.updateConfiguration` (API < 33) ou `context.createConfigurationContext` en propagent le contexte résultant aux écrans, et recharger l’activité après choix de la langue.
- **Fonctionnalité – Sessions Firestore sans identifiant exploitable** : les sessions envoyées vers Firestore gardent `id=""` dans le payload (`app/src/main/java/com/releaf/app/data/model/firebase/Session.kt:7`), car `SessionRepository.createSession` ne réinjecte jamais l’ID généré (`app/src/main/java/com/releaf/app/data/repository/firebase/SessionRepository.kt:16`). Toute mise à jour/suppression ultérieure devient impossible. *Préconisation* : générer l’ID côté client (`document()`), l’écrire dans le modèle avant `set`, et retourner/propager cet ID jusqu’au ViewModel.
- **Sécurité – Données sensibles en clair** : les entités Room stockent email, préférences et statistiques sans chiffrement (`app/src/main/java/com/releaf/app/data/user/User.kt:14`, `app/src/main/java/com/releaf/app/data/database/AppDatabase.kt:33`). Pour une appli bien-être, ces informations relèvent de données personnelles. *Préconisation* : migrer vers `EncryptedSharedPreferences`/`SQLCipher` ou Room + `SupportFactory` chiffrée, et documenter la politique de rétention.
- **Localisation – Interface figée en français** : de nombreuses chaînes UI restent codées en dur (ex. libellés de navigation `app/src/main/java/com/releaf/app/ui/navigation/BottomNavigation.kt:17` ou titres d’écran `app/src/main/java/com/releaf/app/ui/screens/HomeScreen.kt:74`). Les ressources `values-en`, `values-es`, `values-zh-rCN` ne sont jamais sollicitées. *Préconisation* : déplacer tous les textes vers `strings.xml`, utiliser `stringResource`, et fournir des traductions alignées.

## Moyennes
- **Fonctionnalité – Échec silencieux lors de l’enregistrement de session** : `SessionViewModel.completeSession` ignore le `Result` renvoyé par `StatisticsService.recordSession` (`app/src/main/java/com/releaf/app/ui/viewmodel/SessionViewModel.kt:60`). En cas d’utilisateur déconnecté ou d’erreur réseau, l’UI passe à « session terminée » sans persister. *Préconisation* : inspecter le `Result`, afficher une erreur et ne clore la session qu’après succès.
- **Maintenance – Structure de favoris fragile** : les IDs favoris sont sérialisés dans une chaîne séparée par des virgules (`app/src/main/java/com/releaf/app/data/FavoritesPreferences.kt:31`), ce qui expose à des collisions (IDs contenant `,`) et à des lectures concurrentes incohérentes. *Préconisation* : utiliser `Set<String>` de `SharedPreferences` ou migrer vers DataStore avec sérialisation structurée.
- **Fonctionnalité – Service de progression global** : `ProgressService` conserve un seul état de progression en mémoire (`app/src/main/java/com/releaf/app/services/ProgressService.kt:18`). Après une déconnexion, le nouvel utilisateur hérite des données précédentes. *Préconisation* : scoper le service par utilisateur (injection / reset explicite) ou injecter un dépôt persistant.
- **Technique – Migration Room absente** : la base Room est créée sans stratégie de migration (`app/src/main/java/com/releaf/app/data/database/AppDatabase.kt:35`), entraînant des crashs dès qu’un nouveau schéma sera livré. *Préconisation* : définir des migrations versionnées ou, a minima, activer `fallbackToDestructiveMigration` en debug et documenter les évolutions.
- **Localisation & Contenu – Libellés métier intégrés aux enums** : `TechniqueCategory`, `RecommendationReason` et autres enums exposent directement des textes français (`app/src/main/java/com/releaf/app/data/model/RoutineOfDay.kt:33`, `app/src/main/java/com/releaf/app/data/model/Recommendation.kt:23`). Impossible de traduire depuis les ressources. *Préconisation* : stocker des ids de ressource ou des clés et résoudre les textes dans la couche UI.
- **Qualité – Couverture de tests inexistante** : le dossier `app/src/test` est vide. *Préconisation* : ajouter des tests unitaires ciblant les services (p. ex. calcul de streak, attribution des badges) et une batterie d’instrumentation pour les flux critiques (auth, son, changement de langue).

## Mineures
- **Observabilité – Log debug en production** : `SplashScreenRobust` imprime directement sur la sortie standard (`app/src/main/java/com/releaf/app/ui/screens/SplashScreenRobust.kt:59`). *Préconisation* : remplacer par `Log.d` protégé par un flag ou supprimer en release.
- **Localisation – Nom de langue incomplet** : `getCurrentLanguageDisplayName` retombe systématiquement sur "Français" pour toute langue non gérée (`app/src/main/java/com/releaf/app/data/LanguagePreferences.kt:24`). *Préconisation* : couvrir toutes les locales supportées et prévoir un libellé neutre.
- **UX – Navigation favoris silencieuse hors connexion** : `FavoritesViewModel` cesse d’observer sans informer l’UI lorsque l’utilisateur n’est pas authentifié (`app/src/main/java/com/releaf/app/ui/viewmodel/FavoritesViewModel.kt:29`). *Préconisation* : exposer un état explicite (ex. message incitant à se connecter).

## Sujets transverses à planifier
- Harmoniser les dépendances : vérifier la compatibilité de l’AGP 8.12.3 avec les versions Compose/Navigation retenues et planifier une montée de version si nécessaire.
- Documenter les prérequis Firebase (règles de sécurité, collecte de données) dans le README et prévoir un audit des règles Firestore correspondant aux nouveaux champs (sessions, badges, préférences).
